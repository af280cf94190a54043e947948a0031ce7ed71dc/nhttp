var h={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",419:"Insufficient Space on Resource",420:"Method Failure",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",507:"Insufficient Storage",511:"Network Authentication Required"},w={aac:"audio/aac",abw:"application/x-abiword",ai:"application/postscript",arc:"application/octet-stream",avi:"video/x-msvideo",azw:"application/vnd.amazon.ebook",bin:"application/octet-stream",bz:"application/x-bzip",bz2:"application/x-bzip2",csh:"application/x-csh",css:"text/css",csv:"text/csv",doc:"application/msword",dll:"application/octet-stream",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jar:"application/java-archive",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",mid:"audio/midi",midi:"audio/midi",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpa:"video/mpeg",mpe:"video/mpeg",mpeg:"video/mpeg",mpkg:"application/vnd.apple.installer+xml",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",otf:"font/otf",png:"image/png",pdf:"application/pdf",ppt:"application/vnd.ms-powerpoint",rar:"application/x-rar-compressed",rtf:"application/rtf",sh:"application/x-sh",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",ts:"application/typescript",ttf:"font/ttf",txt:"text/plain",vsd:"application/vnd.visio",wav:"audio/x-wav",weba:"audio/webm",webm:"video/webm",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xlsx_OLD:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xml:"application/xml",xul:"application/vnd.mozilla.xul+xml",zip:"application/zip","3gp":"video/3gpp","3gp_DOES_NOT_CONTAIN_VIDEO":"audio/3gpp","3gp2":"video/3gpp2","3gp2_DOES_NOT_CONTAIN_VIDEO":"audio/3gpp2","7z":"application/x-7z-compressed"};var m="application/json; charset=UTF-8",j=class{constructor(e,t){this.resp=e;this.request=t}header(e,t){if(this.init||(this.init={}),this.init.headers?this.init.headers instanceof Headers&&(this.init.headers=Object.fromEntries(this.init.headers.entries())):this.init.headers={},typeof e=="string")return e=e.toLowerCase(),t?(this.init.headers[e]=t,this):this.init.headers[e];if(typeof e=="object"){e instanceof Headers&&(e=Object.fromEntries(e.entries()));for(let i in e)this.init.headers[i.toLowerCase()]=e[i];return this}return this.init.headers=new Headers(this.init.headers)}get headers(){return this.init||(this.init={}),this.init.headers instanceof Headers?this.init.headers:this.init.headers=new Headers(this.init.headers)}set headers(e){this.init||(this.init={}),this.init.headers=e}status(e){return this.init||(this.init={}),e?(this.init.statusText=h[e],this.init.status=e,this):this.init.status||200}sendStatus(e){try{return this.status(e).send(h[e])}catch{return this.status(400).send(h[e])}}setHeader(e,t){return this.header(e,t)}getHeader(e){return this.header(e)}sendFile(e,t={}){return(async()=>{try{P(t);let i=await t.stat?.(e);if(this.type(this.header("content-type")??C(e)),t.etag&&N(this,i))return this.status(304).send();let n=await t.readFile?.(e);return this.resp(n,this.init)}catch(i){throw i.name=="NotFound"&&(i.status=404),i}})()}download(e,t,i={}){return t=t??e.substring(e.lastIndexOf("/")+1),(async()=>{try{P(i);let n=await i.stat?.(e);if(this.type(this.header("content-type")??C(e)),this.header("content-disposition",`attachment; filename=${t}`),i.etag&&N(this,n))return this.status(304).send();let s=await i.readFile?.(e);return this.resp(s,this.init)}catch(n){throw n.name=="NotFound"&&(n.status=404),n}})()}get statusCode(){return this.status()}set statusCode(e){this.status(e)}type(e){return this.header("content-type",w[e]??e)}send(e){return A(this.resp,this.init,e)}json(e){return this.init||(this.init={}),this.init.headers?this.type(m):this.init.headers={"content-type":m},this.resp(JSON.stringify(e),this.init)}redirect(e,t){return this.header("Location",e).status(t??302).send()}cookie(e,t,i={}){return i.httpOnly=i.httpOnly!==!1,i.path=i.path||"/",i.maxAge&&(i.expires=new Date(Date.now()+i.maxAge),i.maxAge/=1e3),t=typeof t=="object"?"j:"+JSON.stringify(t):String(t),this.headers.append("Set-Cookie",U(e,t,i)),this}clearCookie(e,t={}){t.httpOnly=t.httpOnly!==!1,this.headers.append("Set-Cookie",U(e,"",{...t,expires:new Date(0)}))}},k=class extends Response{constructor(e,t={}){t.headers?t.headers instanceof Headers?t.headers.set("content-type",m):t.headers["content-type"]=m:t.headers={"content-type":m};super(JSON.stringify(e),t)}};var f=new TextEncoder,b=new TextDecoder,re=new Date,Q=r=>{try{return decodeURI(r)}catch{return r}},g=r=>{try{return decodeURIComponent(r)}catch{return r}};function B(r){return r.length===3?(t,i)=>{let n=t.response;return t.method=t.request.method,t.__wm||(t.__wm=!0,t.getHeaders=()=>Object.fromEntries(t.request.headers.entries()),n.append=(s,o)=>n.headers.append(s,o),n.set=n.header,n.get=s=>n.header(s),n.hasHeader=s=>n.header(s)!==void 0,n.removeHeader=s=>n.headers.delete(s),n.end=n.send,n.writeHead=(s,...o)=>{n.status(s);for(let a=0;a<o.length;a++)typeof o[a]=="object"&&n.header(o[a])},t.respond=({body:s,status:o,headers:a})=>t.respondWith(new Response(s,{status:o,headers:a}))),r(t,n,i)}:r}function y(r){let e=[],t=0,i=r.length;for(;t<i;t++){let n=r[t];Array.isArray(n)?e=e.concat(y(n)):typeof n=="function"&&e.push(B(n))}return e}function F(r){let e={b:1,kb:1024,mb:1048576,gb:1073741824,tb:Math.pow(1024,4),pb:Math.pow(1024,5)};if(typeof r=="number")return r;let t=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i.exec(r),i,n="b";return t?(i=parseFloat(t[1]),n=t[4].toLowerCase()):(i=parseInt(r,10),n="b"),Math.floor(e[n]*i)}function Y(r,e){if(r instanceof RegExp)return{pathx:r,wild:!0};if(/\?|\*|\.|\:/.test(r)===!1&&e===!1)return;let t=!1;return{pathx:new RegExp(`^${r.replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/(\/?)\*/g,(n,s)=>(t=!0,`(${s}.*)?`)).replace(/\.(?=[\w(])/,"\\.")}/*$`),path:r,wild:t}}function G(r,e,t){if(e.length===0)return t;let i=e.shift();i||(r=r||[],Array.isArray(r)&&(i=r.length));let n=+i;isNaN(n)||(r=r||[],i=n),r=r||{};let s=G(r[i],e,t);return r[i]=s,r}function J(r){return r.reduce((t,[i,n])=>{if(t[i])Array.isArray(t[i])?t[i]=[...t[i],n]:t[i]=[t[i],n];else{let[s,o,a]=i.match(/^([^\[]+)((?:\[[^\]]*\])*)/);a&&(a=Array.from(a.matchAll(/\[([^\]]*)\]/g),c=>c[1]),n=G(t[o],a,n)),t[o]=n}return t},{})}function R(r){if(r===null)return{};if(typeof r=="string"){let e=0,t=r.split("&"),i=[],n=t.length;for(;e<n;){let s=t[e].split("=");i.push([Q(s[0]),Q(s[1]||"")]),e++}return J(i)}return J(Array.from(r.entries()))}function ne(r,e){if(r==="")return e;r=new RegExp(r);let t=r.flags+e.flags;return t=Array.from(new Set(t.split(""))).join(),new RegExp(r.source+e.source,t)}function ie(...r){return y(r)}function V(r){return[(e,t)=>(e.path.startsWith(r)&&(e.__url=e.url,e.__path=e.path,e.url=e.url.substring(r.length)||"/",e.path=e.path.substring(r.length)||"/"),t())]}function K(r,e,t,i){r=r=="/"?"":r,t=Array.isArray(t)?t:[t],t.forEach(n=>{n.c_routes.forEach(s=>{let{method:o,path:a,fns:c}=s,u;if(a instanceof RegExp)u=ne(r,a);else{let d=a;d==="/"&&r!==""&&(d=""),u=r+d}i.on(o,u,[e,c])})})}function X(r,e=-1,t=0){for(;(e=r.indexOf("/",e+1))!=-1&&(t++,t!=3););return e}var E;function _(r){return r.substring(E??(E=X(r)))}function Z(r){let e=X(r);if(E&&E!=e)return E=e,_(r)}function U(r,e,t={}){t.encode=!!t.encode,t.encode&&(e="E:"+btoa(f.encode(e).toString()));let i=`${r}=${e}`;return r.startsWith("__Secure")&&(t.secure=!0),r.startsWith("__Host")&&(t.path="/",t.secure=!0,delete t.domain),t.secure&&(i+="; Secure"),t.httpOnly&&(i+="; HttpOnly"),typeof t.maxAge=="number"&&(i+=`; Max-Age=${t.maxAge}`),t.domain&&(i+=`; Domain=${t.domain}`),t.sameSite&&(i+=`; SameSite=${t.sameSite}`),t.path&&(i+=`; Path=${t.path}`),t.expires&&(i+=`; Expires=${t.expires.toUTCString()}`),t.other&&(i+=`; ${t.other.join("; ")}`),i}function se(r){try{r=r.substring(2);let e=atob(r),t=Uint8Array.from(e.split(",")),i=b.decode(t)||r;if(i!==r&&(i.startsWith("j:{")||i.startsWith("j:["))){let n=i.substring(2);return JSON.parse(g(n))}return g(i)}catch{return g(r)}}function I(r,e,t=0){let i=r.headers.get("Cookie");if(i===null)return{};let n={},s=i.split(";"),o=s.length;for(;t<o;){let[a,...c]=s[t].split("="),u=c.join("=");if(e)n[a.trim()]=u.startsWith("E:")?se(u):g(u);else if(u=g(u),u.startsWith("j:{")||u.startsWith("j:[")){let d=u.substring(2);n[a.trim()]=JSON.parse(d)}else n[a.trim()]=u;t++}return n}function C(r){if(r.lastIndexOf(".")<=0)return w.arc;let t=r.substring(r.lastIndexOf(".")+1);return w[t]}function N(r,e){if(!e.size)return!1;let t=e.mtime??re;return r.header("last-modified",t.toUTCString()),r.header("etag",`W/"${e.size}-${t.getTime()}"`),r.request.headers.get("if-none-match")==r.header("ETag")}function P(r={}){r.etag=r.etag??!0,r.readFile=r.readFile??Deno.readTextFile,r.stat=r.stat??(typeof Deno<"u"?Deno.stat:e=>({}))}function A(r,e,t){return typeof t=="object"?t instanceof Response?t:t instanceof Uint8Array||t instanceof ReadableStream||t instanceof Blob?r(t,e):(e||(e={}),e.headers?e.headers instanceof Headers?e.headers.set("content-type",m):e.headers["content-type"]=m:e.headers={"content-type":m},r(JSON.stringify(t),e)):r(t,e)}function oe(r,e){if(r=="")return e;r=new RegExp(r);let t=r.flags+e.flags;return t=Array.from(new Set(t.split(""))).join(),new RegExp(r.source+e.source,t)}function ae(r,e){let t=r.pathx.exec?.(g(e)),i=t?.groups??{};if(!r.wild||!r.path)return i;let n=r.path;if(n.indexOf("*")!==-1){t.shift();let s=t.filter(c=>c!==void 0).filter(c=>c.startsWith("/")).join("").split("/");s.shift();let o={...i,wild:s.filter(c=>c!=="")};if(n==="*"||n.indexOf("/*")!==-1)return o;let a=n.split("/").find(c=>c.startsWith(":")&&c.endsWith("*"));return a&&(a=a.slice(1,-1),o[a]=[o[a]].concat(o.wild).filter(c=>c!==""),delete o.wild),o}return i}function ce(r){let e=r.indexOf("/",1);return e!=-1?r.substring(0,e):r}var O=class{constructor({base:e=""}={}){this.route={};this.c_routes=[];this.midds=[];this.base="";this.base=e,this.base=="/"&&(this.base="")}use(e,...t){let i=t,n="";if(typeof e=="function"&&!i.length)return this.midds=this.midds.concat(B(e)),this;typeof e=="string"?n=e:i=[e].concat(i);let s=i[i.length-1];if(typeof s=="object"&&(s.c_routes||s[0].c_routes))return K(n,y(i),s,this),this;if(n!=""&&n!="*"&&n!="/*"){let o=this.base+n;return this.pmidds=this.pmidds??{},this.pmidds[o]=this.pmidds[o]??V(o),this.pmidds[o]=this.pmidds[o].concat(y(i)),this}return this.midds=this.midds.concat(y(i)),this}on(e,t,...i){t instanceof RegExp?t=oe(this.base,t):(t=="/"&&this.base!=""&&(t=""),t=this.base+t);let n=y(i);return typeof t=="string"&&this.pmidds?.[t]&&(n=this.pmidds[t].concat(n)),n=this.midds.concat(n),this.c_routes.push({method:e,path:t,fns:n}),this}get(e,...t){return this.on("GET",e,...t)}post(e,...t){return this.on("POST",e,...t)}put(e,...t){return this.on("PUT",e,...t)}patch(e,...t){return this.on("PATCH",e,...t)}delete(e,...t){return this.on("DELETE",e,...t)}any(e,...t){return this.on("ANY",e,...t)}head(e,...t){return this.on("HEAD",e,...t)}options(e,...t){return this.on("OPTIONS",e,...t)}trace(e,...t){return this.on("TRACE",e,...t)}connect(e,...t){return this.on("CONNECT",e,...t)}extractAsset(e){let t=e.split("/");return t.shift(),t.reduce((i,n,s,o)=>(this.pmidds?.[i+"/"+n]&&o.splice(s),i+"/"+n),"")}find(e,t,i,n,s,o){if(t=i(t),this.route[e+t]&&t!="")return this.route[e+t];let a=this.route[e]??[];this.route.ANY&&(a=this.route.ANY.concat(a));let c=a.find(d=>d.pathx?.test(t));if(c)return s(()=>ae(c,t)),c.fns;if(t[t.length-1]=="/"&&t!="/"){let d=t.slice(0,-1);if(this.route[e+d])return this.route[e+d]}let u=o?.();if(u)return this.find(e,u,i,n,s,void 0);if(this.pmidds){let d=this.pmidds[t]?t:ce(t);if(t.startsWith(d)&&!this.pmidds[d]&&(d=this.extractAsset(t)),this.pmidds[d])return this.midds.concat(this.pmidds[d],[n])}return this.midds.concat([n])}};var l=class extends Error{constructor(e,t,i){super(t);this.status=e??500,this.message=t??h[this.status]??"Http Error",this.name=i??(h[this.status]??"Http").replace(/\s/g,""),!i&&!this.name.endsWith("Error")&&(this.name+="Error")}};function v(r,e){let t=r.status||r.statusCode||r.code||500;typeof t!="number"&&(t=500);let i;if(e){let n=r.stack?r.stack.split(`
`):[""];n.shift(),i=n.filter(s=>s.indexOf("file://")!==-1).map(s=>s.trim())}return{status:t,message:r.message||"Something went wrong",name:r.name||"HttpError",stack:i}}var p={contentType:f.encode("Content-Type"),filename:f.encode("filename"),name:f.encode('name="'),dashdash:f.encode("--"),boundaryEqual:f.encode("boundary="),returnNewline2:f.encode(`\r
\r
`),carriageReturn:f.encode("\r")};async function H(r){let e=await r.arrayBuffer(),t=new Uint8Array(e),i=ge(r.headers.get("content-type"));if(!i)return;let n=me(t,i);return ue(n)}function ue(r){let e={fields:{},files:{}};for(let t of r){let{headerByte:i,contentByte:n}=he(t),s=de(i);if(typeof s=="string"){if(n.byteLength===1&&n[0]===13)continue;e.fields[s]=b.decode(n)}else{let o={name:s.filename,type:s.contentType,size:n.byteLength,lastModified:Date.now()-1e3,arrayBuffer:()=>n};e.files[s.name]instanceof Array?e.files[s.name].push(o):e.files[s.name]?e.files[s.name]=[e.files[s.name],o]:e.files[s.name]=o}}return{...e.fields,...e.files}}function de(r){let e=T(r,p.contentType);return e<0?L(r):le(r,e)}function le(r,e){let t={},i=r.slice(0,e-2);t=pe(i);let n=r.slice(e+p.contentType.byteLength+2);return t.contentType=b.decode(n),t}function pe(r){let e={},t=T(r,p.filename);return t<0?e.name=L(r):e=fe(r,t),e}function fe(r,e){let t=r.slice(0,e-2),i=r.slice(e+p.filename.byteLength+2,r.byteLength-1),n=L(t),s=b.decode(i);return{name:n,filename:s}}function L(r){let e=T(r,p.name),t=r.slice(e+p.name.byteLength,r.byteLength-1);return b.decode(t)}function he(r){let e=T(r,p.returnNewline2),t=r.slice(0,e),i=r.slice(e+4);return{headerByte:t,contentByte:i}}function me(r,e){let t=ee(p.dashdash,e),i=ee(t,p.dashdash),n=[];for(;!ye(r,i);){r=r.slice(t.byteLength+2);let s=T(r,t);n.push(r.slice(0,s-2)),r=r.slice(s)}return n}function ge(r){let e=f.encode(r),t=T(e,p.boundaryEqual);if(t>=0)return e.slice(t+p.boundaryEqual.byteLength)}function T(r,e,t=0){if(t>=r.length)return-1;t<0&&(t=Math.max(0,r.length+t));let i=e[0];for(let n=t;n<r.length;n++){if(r[n]!==i)continue;let s=n,o=1,a=n;for(;o<e.length&&(a++,r[a]===e[a-s]);)o++;if(o===e.length)return s}return-1}function ye(r,e){for(let t=0,i=e.length;t<i;t++)if(r[t]!==e[t])return!1;return!0}function ee(...r){let e=0;for(let n of r)e+=n.length;let t=new Uint8Array(e),i=0;for(let n of r)t.set(n,i),i+=n.length;return t}var te=class{createBody(e,{parse:t}={}){return t?t(Object.fromEntries(Array.from(e.keys()).map(i=>[i,e.getAll(i).length>1?e.getAll(i):e.get(i)]))):R(e)}isFile(e){return typeof e=="object"&&typeof e.arrayBuffer=="function"}cleanUp(e){for(let t in e)if(Array.isArray(e[t])){let i=e[t];for(let n=0;n<i.length;n++){let s=i[n];if(this.isFile(s)){delete e[t];break}}}else this.isFile(e[t])&&delete e[t]}validate(e,t){let i=0,n=e.length;if(t?.maxCount&&n>t.maxCount)throw new l(400,`${t.name} no more than ${t.maxCount} file`,"BadRequestError");for(;i<n;){let s=e[i],o=s.name.substring(s.name.lastIndexOf(".")+1);if(t?.accept&&!t.accept.includes(o))throw new l(400,`${t.name} only accept ${t.accept}`,"BadRequestError");if(t?.maxSize&&s.size>F(t.maxSize))throw new l(400,`${t.name} to large, maxSize = ${t.maxSize}`,"BadRequestError");i++}}async privUpload(e,t){let i=0,n=e.length;for(;i<n;){let s=e[i];t?.callback&&t.callback(s);let o=t.dest||"";if(o.lastIndexOf("/")===-1&&(o+="/"),o[0]==="/"&&(o=o.substring(1)),!s.filename){let u=Date.now()+s.lastModified.toString()+"_";s.filename=u+s.name}s.path||(s.path=o+s.filename);let a=await s.arrayBuffer(),c=new Uint8Array(a);t.writeFile||(t.writeFile=Deno.writeFile),await t.writeFile(s.path,c),i++}}upload(e){return async(t,i)=>{if(t.body===void 0&&(t.body={}),t.file===void 0&&(t.file={}),t.request.body&&t.request.headers.get("content-type")?.includes("multipart/form-data")){if(t.request.bodyUsed===!1)if(t.request.formData){let n=await t.request.formData();t.body=await this.createBody(n,{parse:t.__parseQuery})}else t.body=await H(t.request)||{};if(Array.isArray(e)){let n=0,s=0,o=e.length;for(;n<o;){let a=e[n];if(a.required&&t.body[a.name]===void 0)throw new l(400,`Field ${a.name} is required`,"BadRequestError");if(t.body[a.name]){t.file[a.name]=t.body[a.name];let c=t.file[a.name],u=Array.isArray(c)?c:[c];this.validate(u,a)}n++}for(;s<o;){let a=e[s];if(t.body[a.name]){t.file[a.name]=t.body[a.name];let c=t.file[a.name],u=Array.isArray(c)?c:[c];await this.privUpload(u,a),delete t.body[a.name]}s++}this.cleanUp(t.body)}else if(typeof e=="object"){let n=e;if(n.required&&t.body[n.name]===void 0)throw new l(400,`Field ${n.name} is required`,"BadRequestError");if(t.body[n.name]){t.file[n.name]=t.body[n.name];let s=t.file[n.name],o=Array.isArray(s)?s:[s];this.validate(o,n),await this.privUpload(o,n),delete t.body[n.name]}this.cleanUp(t.body)}}return i()}}},M=new te;var be="3mb";async function D(r,e=be){let t=await r.arrayBuffer();if(e&&t.byteLength>F(e))throw new l(400,`Body is too large. max limit ${e}`,"BadRequestError");return g(b.decode(t))}function q(r,e){let t=r.get("content-type");return t===e||t?.startsWith(e)}function $(r,e,t){return async(n,s)=>{if(n.body||(n.body={}),n.request.body&&n.request.bodyUsed==!1&&typeof r!="boolean"){r==null&&(r={});let o=n.request.headers;if(q(o,"application/json")){if(r.json==!1||r.json==0)return s();try{let a=await D(n.request,r.json);n.body=JSON.parse(a)}catch(a){return s(a)}}else if(q(o,"application/x-www-form-urlencoded")){if(r.urlencoded==!1||r.urlencoded==0)return s();try{let a=await D(n.request,r.urlencoded),c=e||R;n.body=c(a)}catch(a){return s(a)}}else if(q(o,"text/plain")){if(r.raw===!1||r.raw===0)return s();try{let a=await D(n.request,r.raw);try{n.body=JSON.parse(a)}catch{n.body={_raw:a}}}catch(a){return s(a)}}else if(q(o,"multipart/form-data")){if(r.multipart==!1||r.multipart==0)return s();try{if(n.request.formData){let a=await n.request.formData();n.body=await M.createBody(a,{parse:t})}else n.body=await H(n.request)||{}}catch(a){return s(a)}}}return s()}}var S=class{constructor(e,t,i){this.request=e;this._info=t;this._ctx=i;this.path=_(e.url)}get response(){return this.res??(this.res=new j(this.resp.bind(this),this.request))}respondWith(e){return this.c_res=e}resp(e,t){return this.c_res=new Response(e,t)}get info(){return this._info??(this._info={})}get context(){return this._ctx??(this._ctx={})}get responseInit(){let e=this.res?.init??{},t=e.status??200,i=e.headers instanceof Headers?e.headers:new Headers(e.headers??{}),n=h[t];return{headers:i,status:t,statusText:n}}get search(){return this._search??null}set search(e){this._search=e}get method(){return this._method??(this._method=this.request.method)}set method(e){this._method=e}get file(){return this._file??(this._file={})}set file(e){this._file=e}get cookies(){return this._cookies??(this._cookies=I(this.request,!0))}set cookies(e){this._cookies=e}get params(){return this._params??(this._params=this.__params?.()??{})}set params(e){this._params=e}get body(){return this._body??(this._body={})}set body(e){this._body=e}get url(){return this._url??(this._url=_(this.request.url))}set url(e){this._url=e}get originalUrl(){return _(this.request.url)}get query(){return this._query??(this._query={})}set query(e){this._query=e}getCookies(e){return I(this.request,e)}};var z=(r,e,t)=>{let i=v(r,t);return e.response.status(i.status).json(i)},Re=()=>new Promise(r=>setTimeout(r)),Te="++)] is not a function",W=class extends O{constructor({parseQuery:e,bodyParser:t,env:i,flash:n,stackError:s}={}){super();this.parseQuery=e||R,this.multipartParseQuery=e,this.bodyParser=t,this.stackError=s!==!1,this.env=i??"development",this.env!=="development"&&(this.stackError=!1),this.flash=n,this.handleEvent=(o,a,c)=>this.handleRequest(o.request,a,c),this.handle=(o,a,c)=>this.handleRequest(o,a,c),e&&this.use((o,a)=>(o.__parseQuery=e,a()))}onError(e){return this._onError=(t,i,n)=>{i.__onErr=!0;let s=t.status||t.statusCode||t.code||500;return typeof s!="number"&&(s=500),i.response.status(s),e(t,i,n)},this}on404(e){return this._on404=(t,i)=>(t.response.status(404),e(t,i)),this}on(e,t,...i){let n=y(i);typeof t=="string"&&this.pmidds?.[t]&&(n=this.pmidds[t].concat([(c,u)=>(c.url=c.__url,c.path=c.__path,u())],n)),n=this.midds.concat(n);let{path:s,pathx:o,wild:a}=Y(t,e==="ANY")??{};return o?(this.route[e]=this.route[e]??[],this.route[e].push({path:s,pathx:o,fns:n,wild:a})):this.route[e+t]=n,this}is404(e){return typeof e.message=="string"&&e.name=="TypeError"&&e.message.includes(Te)}handleRequest(e,t,i){let n=0,s=new S(e,t,i),o=e.method,a=this.route[o+s.path]??this.find(o,s.path,u=>{let d=s.path.indexOf("?");return d!=-1?(s.url=s.path,s.path=s.url.substring(0,d),s.query=this.parseQuery(s.url.substring(d+1)),s.search=s.url.substring(d),s.path):u},this._on404,u=>{s.__params=u},()=>Z(e.url)),c=u=>{try{let d=u?u._$?u.v:this._onError(u,s,c):a[n++](s,c);return typeof d=="string"?s.resp(d,s.res?.init):d?d.then?(async()=>{try{let x=await d;return c({_$:!0,v:x})}catch(x){return this.is404(x)?this._on404(s,c):u?z(x,s,this.stackError):c(x)}})():A(s.resp.bind(s),s.res?.init,d):s.c_res??Re().finally(()=>s.c_res)}catch(d){return this.is404(d)?this._on404(s,c):u?z(d,s,this.stackError):c(d)}};return o=="GET"||o=="HEAD"?c():$(this.bodyParser,this.parseQuery,this.multipartParseQuery)(s,c)}listen(e,t){return(async()=>{let i=!1,n=this.handle;typeof e=="number"?e={port:e}:typeof e=="object"&&(i=e.certFile!==void 0||e.cert!==void 0||e.alpnProtocols!==void 0,n=e.handler??this.handle);let s=o=>{if(t){let a=e;t(o,{...a,hostname:a.hostname||"localhost"})}};try{if(this.flash){if(Deno.serve==null){console.log("Deno flash is unstable. please add --unstable flag.");return}if(e.onListen=e.onListen??(()=>{}),s(),e.test)return;await Deno.serve(e,n)}else{if(s(),e.signal&&e.signal.addEventListener("abort",()=>{try{this.server?.close()}catch{}},{once:!0}),e.test)return;for(this.server=(i?Deno.listenTls:Deno.listen)(e);;)try{let o=await this.server.accept();if(o)this.handleConn(o,n);else break}catch{}}}catch(o){s(o)}})()}_onError(e,t,i){return z(e,t,this.stackError)}_on404(e,t){let i=v(new l(404,`Route ${e.request.method}${e.url} not found`,"NotFoundError"));return e.response.status(i.status).json(i)}async handleConn(e,t){try{let i=Deno.serveHttp(e);for(;;)try{let n=await i.nextRequest();if(n)await n.respondWith(t(n.request,e));else break}catch{break}}catch{}}};function xe(r={}){return new W(r)}export{l as HttpError,j as HttpResponse,k as JsonResponse,W as NHttp,S as RequestEvent,O as Router,$ as bodyParser,ie as expressMiddleware,v as getError,M as multipart,xe as nhttp};
