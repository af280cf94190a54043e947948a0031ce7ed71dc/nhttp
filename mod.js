function U(r){let t=r.indexOf("/",1);return t!==-1?r.substring(0,t):r}var b=class{constructor({base:t=""}={}){this.route={};this.c_routes=[];this.midds=[];this.base="";this.base=t,this.base==="/"&&(this.base=""),this.get=this.on.bind(this,"GET"),this.post=this.on.bind(this,"POST"),this.put=this.on.bind(this,"PUT"),this.patch=this.on.bind(this,"PATCH"),this.delete=this.on.bind(this,"DELETE"),this.any=this.on.bind(this,"ANY"),this.head=this.on.bind(this,"HEAD"),this.options=this.on.bind(this,"OPTIONS"),this.trace=this.on.bind(this,"TRACE"),this.connect=this.on.bind(this,"CONNECT")}single(t,e){let{fns:n,m:s}=this.route[t+e];return s?{params:{},fns:n}:(n=this.midds.concat(n),this.route[t+e]={m:!0,fns:n},{params:{},fns:n})}on(t,e,...n){return e==="/"&&this.base!==""&&(e=""),this.c_routes.push({method:t,path:this.base+e,fns:n}),this}find(t,e,n){if(this.route[t+e])return this.single(t,e);if(e!=="/"&&e[e.length-1]==="/"){let c=e.slice(0,-1);if(this.route[t+c])return this.single(t,c)}let s=[],i={},o=0,a={},l=this.route[t]||[],u;this.route.ANY&&(l=this.route.ANY.concat(l));let y=l.length;for(;o<y;){if(a=l[o],a.pathx&&a.pathx.test(e)){u=a.pathx.exec(e),s=a.fns,u.groups&&(i=u.groups||{}),a.wild&&typeof u[1]=="string"&&(i.wild=u[1].split("/"),i.wild.shift());break}o++}if(this.pmidds){let c=U(e||"/");this.pmidds[c]&&(s=this.pmidds[c].concat(s))}return s=this.midds.concat(s,[n]),{params:i,fns:s}}};var g=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/,Q=new TextEncoder,M=new TextDecoder;function m(r){let t=[],e=0,n=r.length;for(;e<n;e++)Array.isArray(r[e])?t=t.concat(m(r[e])):typeof r[e]=="function"&&t.push(r[e]);return t}function H(r){let t={b:1,kb:1<<10,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)};if(typeof r=="number")return r;let e=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i.exec(r),n,s="b";return e?(n=parseFloat(e[1]),s=e[4].toLowerCase()):(n=parseInt(n,10),s="b"),Math.floor(t[s]*n)}function A(r,t){if(/\?|\*|\.|\:/.test(r)===!1&&t===!1)return{};let e=!1;return r=r.replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/(\/?)\*/g,(s,i)=>(e=!0,`(${i}.*)?`)).replace(/\.(?=[\w(])/,"\\."),{pathx:new RegExp(`^${r}/*$`),wild:e}}function F(r,t,e){if(t.length===0)return e;let n=t.shift();n||(r=r||[],Array.isArray(r)&&(n=r.length));let s=+n;isNaN(s)||(r=r||[],n=s),r=r||{};let i=F(r[n],t,e);return r[n]=i,r}function C(r){return r.reduce((e,[n,s])=>{if(e[n])Array.isArray(e[n])?e[n]=[...e[n],s]:e[n]=[e[n],s];else{let[i,o,a]=n.match(/^([^\[]+)((?:\[[^\]]*\])*)/);a&&(a=Array.from(a.matchAll(/\[([^\]]*)\]/g),l=>l[1]),s=F(e[o],a,s)),e[o]=s}return e},{})}function R(r){if(r===null)return{};if(typeof r=="string"){let t=new URLSearchParams(r);return C(Array.from(t.entries()))}return C(Array.from(r.entries()))}function I(...r){let t=r,e=t.length&&t[t.length-1],n=typeof e=="object"&&e.beforeWrap,s=m(t),i=[],o=0,a=s.length;for(;o<a;){let l=s[o];i=i.concat((u,y)=>{let c=u.response;return u.__isWrapMiddleware||(u.headers=u.request.headers,u.method=u.request.method,c.setHeader=c.set=c.header,c.getHeader=c.get=d=>c.header(d),c.hasHeader=d=>c.header(d)!==null,c.removeHeader=d=>c.header().delete(d),c.end=c.send,c.writeHead=(d,...p)=>{c.status(d);for(let h=0;h<p.length;h++)typeof p[h]=="object"&&c.header(p[h])},u.respond=({body:d,status:p,headers:h})=>u.respondWith(new Response(d,{status:p,headers:h})),u.__isWrapMiddleware=!0),n&&n(u,c),l(u,c,y)}),o++}return i}function j(r,t,e={}){if(!g.test(r))throw new TypeError("name is invalid");if(t!==""&&!g.test(t))throw new TypeError("value is invalid");e.encode=!!e.encode,e.encode&&(t="E:"+btoa(Q.encode(t).toString()));let n=`${r}=${t}`;if(r.startsWith("__Secure")&&(e.secure=!0),r.startsWith("__Host")&&(e.path="/",e.secure=!0,delete e.domain),e.secure&&(n+="; Secure"),e.httpOnly&&(n+="; HttpOnly"),typeof e.maxAge=="number"&&Number.isInteger(e.maxAge)&&(n+=`; Max-Age=${e.maxAge}`),e.domain){if(!g.test(e.domain))throw new TypeError("domain is invalid");n+=`; Domain=${e.domain}`}if(e.sameSite&&(n+=`; SameSite=${e.sameSite}`),e.path){if(!g.test(e.path))throw new TypeError("path is invalid");n+=`; Path=${e.path}`}if(e.expires){if(typeof e.expires.toUTCString!="function")throw new TypeError("expires is invalid");n+=`; Expires=${e.expires.toUTCString()}`}return e.other&&(n+=`; ${e.other.join("; ")}`),n}function z(r){try{r=r.substring(2);let t=atob(r),e=Uint8Array.from(t.split(",")),n=M.decode(e)||r;if(n!==r&&(n.startsWith("j:{")||n.startsWith("j:["))){let s=n.substring(2);return JSON.parse(s)}return n}catch(t){return r}}function _(r,t,e=0){let n=r.headers.get("Cookie");if(n===null)return{};let s={},i=n.split(";"),o=i.length;for(;e<o;){let[a,...l]=i[e].split("="),u=l.join("=");s[a.trim()]=t&&u.startsWith("E:")?z(u):u,e++}return s}var f=class extends Error{constructor(t,e,n){super(e);this.message=e||"Http Error",this.status=t||500,this.name=n||"HttpError"}};function w(r,t){let e=r.status||r.statusCode||r.code||500;typeof e!="number"&&(e=500);let n;if(t){let s=r.stack?r.stack.split(`
`):[""];s.shift(),n=s.filter(i=>i.indexOf("file://")!==-1).map(i=>i.trim())}return{status:e,message:r.message||"Something went wrong",name:r.name||"HttpError",stack:n}}var W=new TextDecoder,v=class{createBody(t,{parse:e}={}){return e?e(Object.fromEntries(Array.from(t.keys()).map(n=>[n,t.getAll(n).length>1?t.getAll(n):t.get(n)]))):R(t)}cleanUp(t){for(let e in t)if(Array.isArray(t[e])){let n=t[e];for(let s=0;s<n.length;s++)if(n[s]instanceof File){delete t[e];break}}else t[e]instanceof File&&delete t[e]}validate(t,e){let n=0,s=t.length;if(e?.maxCount&&s>e.maxCount)throw new f(400,`${e.name} no more than ${e.maxCount} file`,"BadRequestError");for(;n<s;){let i=t[n],o=i.name.substring(i.name.lastIndexOf(".")+1);if(e?.accept&&!e.accept.includes(o))throw new f(400,`${e.name} only accept ${e.accept}`,"BadRequestError");if(e?.maxSize&&i.size>H(e.maxSize))throw new f(400,`${e.name} to large, maxSize = ${e.maxSize}`,"BadRequestError");n++}}async privUpload(t,e){let n=Deno.cwd(),s=0,i=t.length;for(;s<i;){let o=t[s],a=o.name.substring(o.name.lastIndexOf(".")+1);e?.callback&&e.callback(o);let l=e.dest||"";l.lastIndexOf("/")===-1&&(l+="/"),o.filename=o.filename||Date.now()+o.lastModified.toString()+"_"+o.name.substring(0,16).replace(/\./g,"")+"."+a,o.path=o.path||(l!=="/"?l:"")+o.filename;let u=await o.arrayBuffer();await Deno.writeFile(n+"/"+l+o.filename,new Uint8Array(u)),s++}}upload(t){return async(e,n)=>{if(e.body===void 0&&(e.body={}),e.file===void 0&&(e.file={}),e.request.body&&e.request.headers.get("content-type")?.includes("multipart/form-data")){if(e.request.bodyUsed===!1){let s=await e.request.formData();e.body=await this.createBody(s,{parse:e.__parseQuery})}if(Array.isArray(t)){let s=0,i=0,o=t.length;for(;s<o;){let a=t[s];if(a.required&&e.body[a.name]===void 0)throw new f(400,`Field ${a.name} is required`,"BadRequestError");if(e.body[a.name]){e.file[a.name]=e.body[a.name];let l=e.file[a.name],u=Array.isArray(l)?l:[l];this.validate(u,a)}s++}for(;i<o;){let a=t[i];if(e.body[a.name]){e.file[a.name]=e.body[a.name];let l=e.file[a.name],u=Array.isArray(l)?l:[l];await this.privUpload(u,a),delete e.body[a.name]}i++}this.cleanUp(e.body)}else if(typeof t=="object"){let s=t;if(s.required&&e.body[s.name]===void 0)throw new f(400,`Field ${s.name} is required`,"BadRequestError");if(e.body[s.name]){e.file[s.name]=e.body[s.name];let i=e.file[s.name],o=Array.isArray(i)?i:[i];this.validate(o,s),await this.privUpload(o,s),delete e.body[s.name]}this.cleanUp(e.body)}}return n()}}};async function E(r,t){let e=await r.arrayBuffer();if(t&&e.byteLength>H(t))throw new f(400,`Body is too large. max limit ${t}`,"BadRequestError");return W.decode(e)}var S=new v;function x(r,t){let e=r.get("content-type");return e===t||e?.startsWith(t)}var P=async(r,t,e,n,s)=>{if(r.body={},r.request.body&&r.request.bodyUsed===!1){let i=r.request.headers;if(x(i,"application/json")){if(s?.json!==0)try{let o=await E(r.request,s?.json||"3mb");r.body=JSON.parse(o)}catch(o){return t(o)}}else if(x(i,"application/x-www-form-urlencoded")){if(s?.urlencoded!==0)try{let o=await E(r.request,s?.urlencoded||"3mb");r.body=e(o)}catch(o){return t(o)}}else if(x(i,"text/plain")){if(s?.raw!==0)try{let o=await E(r.request,s?.raw||"3mb");try{r.body=JSON.parse(o)}catch(a){r.body={_raw:o}}}catch(o){return t(o)}}else if(x(i,"multipart/form-data")&&s?.multipart!==0)try{let o=await r.request.formData();r.body=await S.createBody(o,{parse:n})}catch(o){return t(o)}}return t()};var O="application/json; charset=utf-8",k=new TextEncoder,D=class{},T=class extends Response{constructor(t,e={}){e.headers?e.headers instanceof Headers?e.headers.set("content-type",O):e.headers["content-type"]=O:e.headers={"content-type":O},super(JSON.stringify(t),e)}};function N(r,t,e){r.header=function(n,s){if(e.headers&&e.headers instanceof Headers&&(e.headers=Object.fromEntries(e.headers.entries())),e.headers=e.headers||{},typeof n=="string")return s?(e.headers[n]=s,this):e.headers[n];if(typeof n=="object"){n instanceof Headers&&(n=Object.fromEntries(n.entries()));for(let i in n)e.headers[i]=n[i];return this}return e.headers=new Headers(e.headers)},r.status=function(n){return n?(e.status=n,this):e.status||200},r.type=function(n){return this.header("Content-Type",n),this},r.send=function(n){return typeof n=="string"?t(new Response(k.encode(n),e)):typeof n=="object"?n instanceof Response?t(n):n instanceof Uint8Array||n instanceof ReadableStream||n instanceof FormData||n instanceof Blob||typeof n.read=="function"?t(new Response(n,e)):t(new T(n,e)):t(new Response(n,e))},r.json=function(n){return t(new T(n,e))},r.redirect=function(n,s){return this.header("Location",n).status(s||302).send()},r.cookie=function(n,s,i={}){return i.httpOnly=i.httpOnly!==!1,i.path=i.path||"/",i.maxAge&&(i.expires=new Date(Date.now()+i.maxAge),i.maxAge/=1e3),s=typeof s=="object"?"j:"+JSON.stringify(s):String(s),this.header().append("Set-Cookie",j(n,s,i)),this},r.clearCookie=function(n,s={}){s.httpOnly=s.httpOnly!==!1,this.header().append("Set-Cookie",j(n,"",{...s,expires:new Date(0)}))}}var $=(r,t,e)=>{let n=w(r,e==="development");return t.response.status(n.status).json(n)},B=class extends b{constructor({parseQuery:t,bodyLimit:e,env:n}={}){super();this.parseQuery=t||R,this.multipartParseQuery=t,this.bodyLimit=e,this.env=n||"development",t&&this.use((s,i)=>(s.__parseQuery=t,i()))}onError(t){return this._onError=(e,n,s)=>{let i=e.status||e.statusCode||e.code||500;return typeof i!="number"&&(i=500),n.response.status(i),t(e,n,s)},this}on404(t){return this._on404=(e,n)=>(e.response.status(404),t(e,n)),this}use(...t){let e=typeof t[0]=="string"?t[0]:"",n=t[t.length-1];if(e==="/"&&(e=""),t.length===1&&typeof t[0]=="function")this.midds=this.midds.concat(t[0]);else if(typeof n=="object"&&(n.c_routes||n[0].c_routes)){let s=m(t);n=Array.isArray(n)?n:[n];let i=0,o=0;for(;i<n.length;i++)for(;o<n[i].c_routes.length;o++){let{method:a,path:l,fns:u}=n[i].c_routes[o];this.on(a,e+l,...s.concat(u))}}else e!==""?(this.pmidds=this.pmidds||{},this.pmidds[e]=[(s,i)=>(s.url=s.url.substring(e.length)||"/",s.path=s.path.substring(e.length)||"/",i())].concat(m(t))):this.midds=this.midds.concat(m(t));return this}on(t,e,...n){let s=m(n),{wild:i,pathx:o}=A(e,t==="ANY");return o?(this.route[t]=this.route[t]||[],this.route[t].push({wild:i,pathx:o,fns:s})):this.route[t+e]={fns:s},this}handle(t,e){let n=0,s=-1,i=0,o=0,a,{method:l,url:u}=t.request;for(t.search=null,t.query={};(s=u.indexOf("/",s+1))!=-1;)if(i+=1,i===3){for(t.url=t.path=u.substring(s),a=t.url.length;o<a;){if(t.url.charCodeAt(o)===63){t.path=t.url.substring(0,o),t.query=this.parseQuery(t.url.substring(o+1)),t.search=t.url.substring(o);break}o++}break}let{fns:y,params:c}=this.find(l,t.path,this._on404),d=p=>{let h;try{h=p?this._onError(p,t,d):y[n++](t,d)}catch(q){return p?$(q,t,this.env):d(q)}if(h)return typeof h.then=="function"?this.withPromise(h,t,d):t.response.send(h)};return t.params=c,t.getCookies=p=>_(t.request,p),e&&(t.respondWith=p=>p),N(t.response={},t.respondWith,t.responseInit={}),l==="GET"||l==="HEAD"?d():P(t,d,this.parseQuery,this.multipartParseQuery,this.bodyLimit)}handleEvent(t){return this.handle(t,!0)}async listen(t,e){let n=!1;typeof t=="number"?t={port:t}:typeof t=="object"&&(n=t.certFile!==void 0),this.server=n?Deno.listenTls(t):Deno.listen(t);try{for(e&&e(void 0,{...t,hostname:t.hostname||"localhost",server:this.server});;)try{let s=await this.server.accept();if(s)this.handleConn(s);else break}catch(s){}}catch(s){e&&e(s,{...t,hostname:t.hostname||"localhost",server:this.server})}}_onError(t,e,n){return $(t,e,this.env)}_on404(t,e){let n=w(new f(404,`Route ${t.request.method}${t.url} not found`,"NotFoundError"));return t.response.status(n.status).json(n)}async handleConn(t){try{let e=Deno.serveHttp(t);for await(let n of e){let s,i=new Promise(a=>s=a),o=n.respondWith(i);n.conn=t,n.respondWith=s,this.handle(n),await o}}catch(e){}}async withPromise(t,e,n,s){try{let i=await t;return i?e.response.send(i):void 0}catch(i){return s?this._onError(i,e,n):n(i)}}};var L=class{};export{f as HttpError,D as HttpResponse,T as JsonResponse,B as NHttp,L as RequestEvent,b as Router,I as expressMiddleware,w as getError,S as multipart};
