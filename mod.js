var W=new TextEncoder,Q=new TextDecoder,R=r=>{try{return decodeURI(r)}catch(t){return r}};function b(r){let t=[],e=0,n=r.length;for(;e<n;e++)Array.isArray(r[e])?t=t.concat(b(r[e])):typeof r[e]=="function"&&t.push(r[e]);return t}function H(r){let t={b:1,kb:1<<10,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)};if(typeof r=="number")return r;let e=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i.exec(r),n,s="b";return e?(n=parseFloat(e[1]),s=e[4].toLowerCase()):(n=parseInt(r,10),s="b"),Math.floor(t[s]*n)}function _(r,t){if(r instanceof RegExp)return{pathx:r,wild:!0};if(/\?|\*|\.|\:/.test(r)===!1&&t===!1)return{};let e=!1;return{pathx:new RegExp(`^${r.replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/(\/?)\*/g,(s,i)=>(e=!0,`(${i}.*)?`)).replace(/\.(?=[\w(])/,"\\.")}/*$`),path:r,wild:e}}function C(r,t,e){if(t.length===0)return e;let n=t.shift();n||(r=r||[],Array.isArray(r)&&(n=r.length));let s=+n;isNaN(s)||(r=r||[],n=s),r=r||{};let i=C(r[n],t,e);return r[n]=i,r}function P(r){return r.reduce((e,[n,s])=>{if(e[n])Array.isArray(e[n])?e[n]=[...e[n],s]:e[n]=[e[n],s];else{let[i,o,a]=n.match(/^([^\[]+)((?:\[[^\]]*\])*)/);a&&(a=Array.from(a.matchAll(/\[([^\]]*)\]/g),u=>u[1]),s=C(e[o],a,s)),e[o]=s}return e},{})}function y(r){if(r===null)return{};if(typeof r=="string"){let t=0,e=r.split("&"),n=[],s=e.length;for(;t<s;){let i=e[t].split("=");n.push([R(i[0]),R(i[1]||"")]),t++}return P(n)}return P(Array.from(r.entries()))}function T(r,t){if(r==="")return t;r=new RegExp(r);let e=r.flags+t.flags;return e=Array.from(new Set(e.split(""))).join(),new RegExp(r.source+t.source,e)}function k(...r){let t=r,e=t.length&&t[t.length-1],n=typeof e=="object"&&e.beforeWrap,s=b(t),i=[],o=0,a=s.length;for(;o<a;){let u=s[o];i=i.concat((c,m)=>{let d=c.response;return c.__isWrapMiddleware||(c.headers=c.request.headers,c.method=c.request.method,d.setHeader=d.set=d.header,d.getHeader=d.get=l=>d.header(l),d.hasHeader=l=>d.header(l)!==null,d.removeHeader=l=>d.header().delete(l),d.end=d.send,d.writeHead=(l,...p)=>{d.status(l);for(let f=0;f<p.length;f++)typeof p[f]=="object"&&d.header(p[f])},c.respond=({body:l,status:p,headers:f})=>c.respondWith(new Response(l,{status:p,headers:f})),c.__isWrapMiddleware=!0),n&&n(c,d),u(c,d,m)}),o++}return i}function D(r){return[(t,e)=>(t.url=t.url.substring(r.length)||"/",t.path=t.path.substring(r.length)||"/",e())]}function O(r,t,e={}){e.encode=!!e.encode,e.encode&&(t="E:"+btoa(W.encode(t).toString()));let n=`${r}=${t}`;return r.startsWith("__Secure")&&(e.secure=!0),r.startsWith("__Host")&&(e.path="/",e.secure=!0,delete e.domain),e.secure&&(n+="; Secure"),e.httpOnly&&(n+="; HttpOnly"),typeof e.maxAge=="number"&&(n+=`; Max-Age=${e.maxAge}`),e.domain&&(n+=`; Domain=${e.domain}`),e.sameSite&&(n+=`; SameSite=${e.sameSite}`),e.path&&(n+=`; Path=${e.path}`),e.expires&&(n+=`; Expires=${e.expires.toUTCString()}`),e.other&&(n+=`; ${e.other.join("; ")}`),n}function I(r){try{r=r.substring(2);let t=atob(r),e=Uint8Array.from(t.split(",")),n=Q.decode(e)||r;if(n!==r&&(n.startsWith("j:{")||n.startsWith("j:["))){let s=n.substring(2);return JSON.parse(s)}return n}catch(t){return r}}function S(r,t,e=0){let n=r.headers.get("Cookie");if(n===null)return{};let s={},i=n.split(";"),o=i.length;for(;e<o;){let[a,...u]=i[e].split("="),c=u.join("=");s[a.trim()]=t&&c.startsWith("E:")?I(c):c,e++}return s}function z(r,t,e){let n=e.groups||{};if(!t||!r)return n;if(r.indexOf("*")!==-1){e.shift();let s=e.filter(a=>a!==void 0).filter(a=>a.startsWith("/")).join("").split("/");s.shift();let i={...n,wild:s.filter(a=>a!=="")};if(r==="*"||r.indexOf("/*")!==-1)return i;let o=r.split("/").find(a=>a.startsWith(":")&&a.endsWith("*"));return o&&(o=o.slice(1,-1),i[o]=[i[o]].concat(i.wild).filter(a=>a!==""),delete i.wild),i}return n}function J(r){let t=r.indexOf("/",1);return t!==-1?r.substring(0,t):r}var g=class{constructor({base:t=""}={}){this.route={};this.c_routes=[];this.midds=[];this.base="";this.base=t,this.base==="/"&&(this.base=""),this.get=this.on.bind(this,"GET"),this.post=this.on.bind(this,"POST"),this.put=this.on.bind(this,"PUT"),this.patch=this.on.bind(this,"PATCH"),this.delete=this.on.bind(this,"DELETE"),this.any=this.on.bind(this,"ANY"),this.head=this.on.bind(this,"HEAD"),this.options=this.on.bind(this,"OPTIONS"),this.trace=this.on.bind(this,"TRACE"),this.connect=this.on.bind(this,"CONNECT")}single(t,e){let{fns:n,m:s}=this.route[t+e];return s?{params:{},fns:n}:(n=this.midds.concat(n),this.route[t+e]={m:!0,fns:n},{params:{},fns:n})}on(t,e,...n){let s;return e instanceof RegExp?s=T(this.base,e):(e==="/"&&this.base!==""&&(e=""),s=this.base+e),this.c_routes.push({method:t,path:s,fns:n}),this}find(t,e,n){if(this.route[t+e])return this.single(t,e);if(e!=="/"&&e[e.length-1]==="/"){let d=e.slice(0,-1);if(this.route[t+d])return this.single(t,d)}let s=[],i={},o=0,a={},u=this.route[t]||[],c;this.route.ANY&&(u=this.route.ANY.concat(u));let m=u.length;for(;o<m;){if(a=u[o],a.pathx&&a.pathx.test(e)){if(e=R(e),c=a.pathx.exec(e),s=a.fns,!c)break;i=z(a.path,a.wild,c);break}o++}if(this.pmidds){let d=J(e||"/");this.pmidds[d]&&(s=this.pmidds[d].concat(s))}return s=this.midds.concat(s,[n]),{params:i,fns:s}}};var h=class extends Error{constructor(t,e,n){super(e);this.message=e||"Http Error",this.status=t||500,this.name=n||"HttpError"}};function x(r,t){let e=r.status||r.statusCode||r.code||500;typeof e!="number"&&(e=500);let n;if(t){let s=r.stack?r.stack.split(`
`):[""];s.shift(),n=s.filter(i=>i.indexOf("file://")!==-1).map(i=>i.trim())}return{status:e,message:r.message||"Something went wrong",name:r.name||"HttpError",stack:n}}var Y=new TextDecoder,M=class{createBody(t,{parse:e}={}){return e?e(Object.fromEntries(Array.from(t.keys()).map(n=>[n,t.getAll(n).length>1?t.getAll(n):t.get(n)]))):y(t)}cleanUp(t){for(let e in t)if(Array.isArray(t[e])){let n=t[e];for(let s=0;s<n.length;s++)if(n[s]instanceof File){delete t[e];break}}else t[e]instanceof File&&delete t[e]}validate(t,e){let n=0,s=t.length;if(e?.maxCount&&s>e.maxCount)throw new h(400,`${e.name} no more than ${e.maxCount} file`,"BadRequestError");for(;n<s;){let i=t[n],o=i.name.substring(i.name.lastIndexOf(".")+1);if(e?.accept&&!e.accept.includes(o))throw new h(400,`${e.name} only accept ${e.accept}`,"BadRequestError");if(e?.maxSize&&i.size>H(e.maxSize))throw new h(400,`${e.name} to large, maxSize = ${e.maxSize}`,"BadRequestError");n++}}async privUpload(t,e){let n=Deno.cwd(),s=0,i=t.length;for(;s<i;){let o=t[s],a=o.name.substring(o.name.lastIndexOf(".")+1);e?.callback&&e.callback(o);let u=e.dest||"";u.lastIndexOf("/")===-1&&(u+="/"),o.filename=o.filename||Date.now()+o.lastModified.toString()+"_"+o.name.substring(0,16).replace(/\./g,"")+"."+a,o.path=o.path||(u!=="/"?u:"")+o.filename;let c=await o.arrayBuffer();await Deno.writeFile(n+"/"+u+o.filename,new Uint8Array(c)),s++}}upload(t){return async(e,n)=>{if(e.body===void 0&&(e.body={}),e.file===void 0&&(e.file={}),e.request.body&&e.request.headers.get("content-type")?.includes("multipart/form-data")){if(e.request.bodyUsed===!1){let s=await e.request.formData();e.body=await this.createBody(s,{parse:e.__parseQuery})}if(Array.isArray(t)){let s=0,i=0,o=t.length;for(;s<o;){let a=t[s];if(a.required&&e.body[a.name]===void 0)throw new h(400,`Field ${a.name} is required`,"BadRequestError");if(e.body[a.name]){e.file[a.name]=e.body[a.name];let u=e.file[a.name],c=Array.isArray(u)?u:[u];this.validate(c,a)}s++}for(;i<o;){let a=t[i];if(e.body[a.name]){e.file[a.name]=e.body[a.name];let u=e.file[a.name],c=Array.isArray(u)?u:[u];await this.privUpload(c,a),delete e.body[a.name]}i++}this.cleanUp(e.body)}else if(typeof t=="object"){let s=t;if(s.required&&e.body[s.name]===void 0)throw new h(400,`Field ${s.name} is required`,"BadRequestError");if(e.body[s.name]){e.file[s.name]=e.body[s.name];let i=e.file[s.name],o=Array.isArray(i)?i:[i];this.validate(o,s),await this.privUpload(o,s),delete e.body[s.name]}this.cleanUp(e.body)}}return n()}}};async function E(r,t){let e=await r.arrayBuffer();if(t&&e.byteLength>H(t))throw new h(400,`Body is too large. max limit ${t}`,"BadRequestError");return Y.decode(e)}var N=new M;function w(r,t){let e=r.get("content-type");return e===t||e?.startsWith(t)}var $=async(r,t,e,n,s)=>{if(r.body={},r.request.body&&r.request.bodyUsed===!1){let i=r.request.headers;if(w(i,"application/json")){if(s?.json!==0)try{let o=await E(r.request,s?.json||"3mb");r.body=JSON.parse(o)}catch(o){return t(o)}}else if(w(i,"application/x-www-form-urlencoded")){if(s?.urlencoded!==0)try{let o=await E(r.request,s?.urlencoded||"3mb");r.body=e(o)}catch(o){return t(o)}}else if(w(i,"text/plain")){if(s?.raw!==0)try{let o=await E(r.request,s?.raw||"3mb");try{r.body=JSON.parse(o)}catch(a){r.body={_raw:o}}}catch(o){return t(o)}}else if(w(i,"multipart/form-data")&&s?.multipart!==0)try{let o=await r.request.formData();r.body=await N.createBody(o,{parse:n})}catch(o){return t(o)}}return t()};var A="application/json; charset=utf-8",G=new TextEncoder,B=class{},j=class extends Response{constructor(t,e={}){e.headers?e.headers instanceof Headers?e.headers.set("content-type",A):e.headers["content-type"]=A:e.headers={"content-type":A},super(JSON.stringify(t),e)}};function L(r,t,e){r.header=function(n,s){if(e.headers&&e.headers instanceof Headers&&(e.headers=Object.fromEntries(e.headers.entries())),e.headers=e.headers||{},typeof n=="string")return n=n.toLowerCase(),s?(e.headers[n]=s,this):e.headers[n];if(typeof n=="object"){n instanceof Headers&&(n=Object.fromEntries(n.entries()));for(let i in n)e.headers[i.toLowerCase()]=n[i];return this}return e.headers=new Headers(e.headers)},r.status=function(n){return n?(e.status=n,this):e.status||200},r.type=function(n){return this.header("content-type",n),this},r.send=function(n){return typeof n=="string"?t(new Response(G.encode(n),e)):typeof n=="object"?n instanceof Response?t(n):n instanceof Uint8Array||n instanceof ReadableStream||n instanceof FormData||n instanceof Blob||typeof n.read=="function"?t(new Response(n,e)):t(new j(n,e)):t(new Response(n,e))},r.json=function(n){return t(new j(n,e))},r.redirect=function(n,s){return this.header("Location",n).status(s||302).send()},r.cookie=function(n,s,i={}){return i.httpOnly=i.httpOnly!==!1,i.path=i.path||"/",i.maxAge&&(i.expires=new Date(Date.now()+i.maxAge),i.maxAge/=1e3),s=typeof s=="object"?"j:"+JSON.stringify(s):String(s),this.header().append("Set-Cookie",O(n,s,i)),this},r.clearCookie=function(n,s={}){s.httpOnly=s.httpOnly!==!1,this.header().append("Set-Cookie",O(n,"",{...s,expires:new Date(0)}))}}var q=(r,t,e)=>{let n=x(r,e==="development");return t.response.status(n.status).json(n)},U=class extends g{constructor({parseQuery:t,bodyLimit:e,env:n}={}){super();this.parseQuery=t||y,this.multipartParseQuery=t,this.bodyLimit=e,this.env=n||"development",t&&this.use((s,i)=>(s.__parseQuery=t,i()))}onError(t){return this._onError=(e,n,s)=>{n.__onErr=!0;let i=e.status||e.statusCode||e.code||500;return typeof i!="number"&&(i=500),n.response.status(i),t(e,n,s)},this}on404(t){return this._on404=(e,n)=>(e.response.status(404),t(e,n)),this}use(t,...e){let n=e,s="";if(typeof t=="function"&&n.length===0)return this.midds=this.midds.concat(t),this;typeof t=="string"?s=t==="/"?"":t:n=[t].concat(n);let i=n[n.length-1];return typeof i=="object"&&(i.c_routes||i[0].c_routes)?this.pushRoutes(s,b(n),i):s!==""?(this.pmidds=this.pmidds||{},this.pmidds[s]=D(s).concat(b(n))):this.midds=this.midds.concat(b(n)),this}on(t,e,...n){let s=b(n),{path:i,pathx:o,wild:a}=_(e,t==="ANY");return o?(this.route[t]=this.route[t]||[],this.route[t].push({path:i,pathx:o,fns:s,wild:a})):this.route[t+e]={fns:s},this}handle(t,e){let n=0,s=-1,i=0,o=0,a,{method:u,url:c}=t.request;for(t.search=null,t.query={};(s=c.indexOf("/",s+1))!=-1;)if(i+=1,i===3){for(t.url=t.path=c.substring(s),a=t.url.length;o<a;){if(t.url.charCodeAt(o)===63){t.path=t.url.substring(0,o),t.query=this.parseQuery(t.url.substring(o+1)),t.search=t.url.substring(o);break}o++}break}let{fns:m,params:d}=this.find(u,t.path,this._on404),l=p=>{let f;try{f=p?this._onError(p,t,l):m[n++](t,l)}catch(F){return p?q(F,t,this.env):l(F)}if(f)return typeof f.then=="function"?this.withPromise(f,t,l,t.__onErr):t.response.send(f)};return t.params=d,t.getCookies=p=>S(t.request,p),e&&(t.respondWith=p=>p),L(t.response={},t.respondWith,t.responseInit={}),u==="GET"||u==="HEAD"?l():$(t,l,this.parseQuery,this.multipartParseQuery,this.bodyLimit)}handleEvent(t){return this.handle(t,!0)}async listen(t,e){let n=!1;typeof t=="number"?t={port:t}:typeof t=="object"&&(n=t.certFile!==void 0);try{for(this.server=n?Deno.listenTls(t):Deno.listen(t),e&&e(void 0,{...t,hostname:t.hostname||"localhost",server:this.server});;)try{let s=await this.server.accept();if(s)this.handleConn(s);else break}catch(s){}}catch(s){e&&e(s,{...t,hostname:t.hostname||"localhost"})}}pushRoutes(t,e,n){n=Array.isArray(n)?n:[n],n.forEach(s=>{s.c_routes.forEach(i=>{let{method:o,path:a,fns:u}=i,c;if(a instanceof RegExp)c=T(t,a);else{let m=a;m==="/"&&t!==""&&(m=""),c=t+m}this.on(o,c,[e,u])})})}_onError(t,e,n){return q(t,e,this.env)}_on404(t,e){let n=x(new h(404,`Route ${t.request.method}${t.url} not found`,"NotFoundError"));return t.response.status(n.status).json(n)}async handleConn(t){try{let e=Deno.serveHttp(t);for await(let n of e){let s,i=new Promise(a=>s=a),o=n.respondWith(i);n.conn=t,n.respondWith=s,this.handle(n),await o}}catch(e){}}async withPromise(t,e,n,s){try{let i=await t;return i?e.response.send(i):void 0}catch(i){return s?q(i,e,this.env):n(i)}}};var v=class{};export{h as HttpError,B as HttpResponse,j as JsonResponse,U as NHttp,v as RequestEvent,g as Router,k as expressMiddleware,x as getError,N as multipart};
