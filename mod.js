var Q=s=>{try{return decodeURI(s)}catch(t){return s}};function I(s,t){if(s==="")return t;s=new RegExp(s);let e=s.flags+t.flags;return e=Array.from(new Set(e.split(""))).join(),new RegExp(s.source+t.source,e)}function k(s,t,e){let n=e.groups||{};if(!t||!s)return n;if(s.indexOf("*")!==-1){e.shift();let r=e.filter(a=>a!==void 0).filter(a=>a.startsWith("/")).join("").split("/");r.shift();let i={...n,wild:r.filter(a=>a!=="")};if(s==="*"||s.indexOf("/*")!==-1)return i;let o=s.split("/").find(a=>a.startsWith(":")&&a.endsWith("*"));return o&&(o=o.slice(1,-1),i[o]=[i[o]].concat(i.wild).filter(a=>a!==""),delete i.wild),i}return n}function z(s){let t=s.indexOf("/",1);return t!==-1?s.substring(0,t):s}var g=class{constructor({base:t=""}={}){this.route={};this.c_routes=[];this.midds=[];this.base="";this.base=t,this.base==="/"&&(this.base=""),this.get=this.on.bind(this,"GET"),this.post=this.on.bind(this,"POST"),this.put=this.on.bind(this,"PUT"),this.patch=this.on.bind(this,"PATCH"),this.delete=this.on.bind(this,"DELETE"),this.any=this.on.bind(this,"ANY"),this.head=this.on.bind(this,"HEAD"),this.options=this.on.bind(this,"OPTIONS"),this.trace=this.on.bind(this,"TRACE"),this.connect=this.on.bind(this,"CONNECT")}single(t,e){let{fns:n,m:r}=this.route[t+e];return r?{params:{},fns:n}:(n=this.midds.concat(n),this.route[t+e]={m:!0,fns:n},{params:{},fns:n})}on(t,e,...n){let r;return e instanceof RegExp?r=I(this.base,e):(e==="/"&&this.base!==""&&(e=""),r=this.base+e),this.c_routes.push({method:t,path:r,fns:n}),this}find(t,e,n){if(this.route[t+e])return this.single(t,e);if(e!=="/"&&e[e.length-1]==="/"){let d=e.slice(0,-1);if(this.route[t+d])return this.single(t,d)}let r=[],i={},o=0,a={},u=this.route[t]||[],c;this.route.ANY&&(u=this.route.ANY.concat(u));let h=u.length;for(;o<h;){if(a=u[o],a.pathx&&a.pathx.test(e)){if(e=Q(e),c=a.pathx.exec(e),r=a.fns,!c)break;i=k(a.path,a.wild,c);break}o++}if(this.pmidds){let d=z(e||"/");this.pmidds[d]&&(r=this.pmidds[d].concat(r))}return r=this.midds.concat(r,[n]),{params:i,fns:r}}};var J=new TextEncoder,Y=new TextDecoder,_=s=>{try{return decodeURI(s)}catch(t){return s}},R=s=>{try{return decodeURIComponent(s)}catch(t){return s}};function b(s){let t=[],e=0,n=s.length;for(;e<n;e++)Array.isArray(s[e])?t=t.concat(b(s[e])):typeof s[e]=="function"&&t.push(s[e]);return t}function j(s){let t={b:1,kb:1<<10,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)};if(typeof s=="number")return s;let e=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i.exec(s),n,r="b";return e?(n=parseFloat(e[1]),r=e[4].toLowerCase()):(n=parseInt(s,10),r="b"),Math.floor(t[r]*n)}function F(s,t){if(s instanceof RegExp)return{pathx:s,wild:!0};if(/\?|\*|\.|\:/.test(s)===!1&&t===!1)return{};let e=!1;return{pathx:new RegExp(`^${s.replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/(\/?)\*/g,(r,i)=>(e=!0,`(${i}.*)?`)).replace(/\.(?=[\w(])/,"\\.")}/*$`),path:s,wild:e}}function C(s,t,e){if(t.length===0)return e;let n=t.shift();n||(s=s||[],Array.isArray(s)&&(n=s.length));let r=+n;isNaN(r)||(s=s||[],n=r),s=s||{};let i=C(s[n],t,e);return s[n]=i,s}function S(s){return s.reduce((e,[n,r])=>{if(e[n])Array.isArray(e[n])?e[n]=[...e[n],r]:e[n]=[e[n],r];else{let[i,o,a]=n.match(/^([^\[]+)((?:\[[^\]]*\])*)/);a&&(a=Array.from(a.matchAll(/\[([^\]]*)\]/g),u=>u[1]),r=C(e[o],a,r)),e[o]=r}return e},{})}function y(s){if(s===null)return{};if(typeof s=="string"){let t=0,e=s.split("&"),n=[],r=e.length;for(;t<r;){let i=e[t].split("=");n.push([_(i[0]),_(i[1]||"")]),t++}return S(n)}return S(Array.from(s.entries()))}function P(s,t){if(s==="")return t;s=new RegExp(s);let e=s.flags+t.flags;return e=Array.from(new Set(e.split(""))).join(),new RegExp(s.source+t.source,e)}function G(...s){let t=s,e=t.length&&t[t.length-1],n=typeof e=="object"&&e.beforeWrap,r=b(t),i=[],o=0,a=r.length;for(;o<a;){let u=r[o];i=i.concat((c,h)=>{let d=c.response;return c.__isWrapMiddleware||(c.headers=c.request.headers,c.method=c.request.method,d.setHeader=d.set=d.header,d.getHeader=d.get=l=>d.header(l),d.hasHeader=l=>d.header(l)!==null,d.removeHeader=l=>d.header().delete(l),d.end=d.send,d.writeHead=(l,...p)=>{d.status(l);for(let f=0;f<p.length;f++)typeof p[f]=="object"&&d.header(p[f])},c.respond=({body:l,status:p,headers:f})=>c.respondWith(new Response(l,{status:p,headers:f})),c.__isWrapMiddleware=!0),n&&n(c,d),u(c,d,h)}),o++}return i}function D(s){return[(t,e)=>(t.url=t.url.substring(s.length)||"/",t.path=t.path.substring(s.length)||"/",e())]}function E(s,t,e={}){e.encode=!!e.encode,e.encode&&(t="E:"+btoa(J.encode(t).toString()));let n=`${s}=${t}`;return s.startsWith("__Secure")&&(e.secure=!0),s.startsWith("__Host")&&(e.path="/",e.secure=!0,delete e.domain),e.secure&&(n+="; Secure"),e.httpOnly&&(n+="; HttpOnly"),typeof e.maxAge=="number"&&(n+=`; Max-Age=${e.maxAge}`),e.domain&&(n+=`; Domain=${e.domain}`),e.sameSite&&(n+=`; SameSite=${e.sameSite}`),e.path&&(n+=`; Path=${e.path}`),e.expires&&(n+=`; Expires=${e.expires.toUTCString()}`),e.other&&(n+=`; ${e.other.join("; ")}`),n}function V(s){try{s=s.substring(2);let t=atob(s),e=Uint8Array.from(t.split(",")),n=Y.decode(e)||s;if(n!==s&&(n.startsWith("j:{")||n.startsWith("j:["))){let r=n.substring(2);return JSON.parse(R(r))}return R(n)}catch(t){return R(s)}}function M(s,t,e=0){let n=s.headers.get("Cookie");if(n===null)return{};let r={},i=n.split(";"),o=i.length;for(;e<o;){let[a,...u]=i[e].split("="),c=u.join("=");if(t)r[a.trim()]=c.startsWith("E:")?V(c):R(c);else if(c=R(c),c.startsWith("j:{")||c.startsWith("j:[")){let h=c.substring(2);r[a.trim()]=JSON.parse(h)}else r[a.trim()]=c;e++}return r}var m=class extends Error{constructor(t,e,n){super(e);this.message=e||"Http Error",this.status=t||500,this.name=n||"HttpError"}};function T(s,t){let e=s.status||s.statusCode||s.code||500;typeof e!="number"&&(e=500);let n;if(t){let r=s.stack?s.stack.split(`
`):[""];r.shift(),n=r.filter(i=>i.indexOf("file://")!==-1).map(i=>i.trim())}return{status:e,message:s.message||"Something went wrong",name:s.name||"HttpError",stack:n}}var K=new TextDecoder,N=class{createBody(t,{parse:e}={}){return e?e(Object.fromEntries(Array.from(t.keys()).map(n=>[n,t.getAll(n).length>1?t.getAll(n):t.get(n)]))):y(t)}cleanUp(t){for(let e in t)if(Array.isArray(t[e])){let n=t[e];for(let r=0;r<n.length;r++)if(n[r]instanceof File){delete t[e];break}}else t[e]instanceof File&&delete t[e]}validate(t,e){let n=0,r=t.length;if(e?.maxCount&&r>e.maxCount)throw new m(400,`${e.name} no more than ${e.maxCount} file`,"BadRequestError");for(;n<r;){let i=t[n],o=i.name.substring(i.name.lastIndexOf(".")+1);if(e?.accept&&!e.accept.includes(o))throw new m(400,`${e.name} only accept ${e.accept}`,"BadRequestError");if(e?.maxSize&&i.size>j(e.maxSize))throw new m(400,`${e.name} to large, maxSize = ${e.maxSize}`,"BadRequestError");n++}}async privUpload(t,e){let n=Deno.cwd(),r=0,i=t.length;for(;r<i;){let o=t[r],a=o.name.substring(o.name.lastIndexOf(".")+1);e?.callback&&e.callback(o);let u=e.dest||"";u.lastIndexOf("/")===-1&&(u+="/"),o.filename=o.filename||Date.now()+o.lastModified.toString()+"_"+o.name.substring(0,16).replace(/\./g,"")+"."+a,o.path=o.path||(u!=="/"?u:"")+o.filename;let c=await o.arrayBuffer();await Deno.writeFile(n+"/"+u+o.filename,new Uint8Array(c)),r++}}upload(t){return async(e,n)=>{if(e.body===void 0&&(e.body={}),e.file===void 0&&(e.file={}),e.request.body&&e.request.headers.get("content-type")?.includes("multipart/form-data")){if(e.request.bodyUsed===!1){let r=await e.request.formData();e.body=await this.createBody(r,{parse:e.__parseQuery})}if(Array.isArray(t)){let r=0,i=0,o=t.length;for(;r<o;){let a=t[r];if(a.required&&e.body[a.name]===void 0)throw new m(400,`Field ${a.name} is required`,"BadRequestError");if(e.body[a.name]){e.file[a.name]=e.body[a.name];let u=e.file[a.name],c=Array.isArray(u)?u:[u];this.validate(c,a)}r++}for(;i<o;){let a=t[i];if(e.body[a.name]){e.file[a.name]=e.body[a.name];let u=e.file[a.name],c=Array.isArray(u)?u:[u];await this.privUpload(c,a),delete e.body[a.name]}i++}this.cleanUp(e.body)}else if(typeof t=="object"){let r=t;if(r.required&&e.body[r.name]===void 0)throw new m(400,`Field ${r.name} is required`,"BadRequestError");if(e.body[r.name]){e.file[r.name]=e.body[r.name];let i=e.file[r.name],o=Array.isArray(i)?i:[i];this.validate(o,r),await this.privUpload(o,r),delete e.body[r.name]}this.cleanUp(e.body)}}return n()}}};async function O(s,t){let e=await s.arrayBuffer();if(t&&e.byteLength>j(t))throw new m(400,`Body is too large. max limit ${t}`,"BadRequestError");return K.decode(e)}var $=new N;function w(s,t){let e=s.get("content-type");return e===t||e?.startsWith(t)}var B=async(s,t,e,n,r)=>{if(s.body={},s.request.body&&s.request.bodyUsed===!1){let i=s.request.headers;if(w(i,"application/json")){if(r?.json!==0)try{let o=await O(s.request,r?.json||"3mb");s.body=JSON.parse(o)}catch(o){return t(o)}}else if(w(i,"application/x-www-form-urlencoded")){if(r?.urlencoded!==0)try{let o=await O(s.request,r?.urlencoded||"3mb");s.body=e(o)}catch(o){return t(o)}}else if(w(i,"text/plain")){if(r?.raw!==0)try{let o=await O(s.request,r?.raw||"3mb");try{s.body=JSON.parse(o)}catch(a){s.body={_raw:o}}}catch(o){return t(o)}}else if(w(i,"multipart/form-data")&&r?.multipart!==0)try{let o=await s.request.formData();s.body=await $.createBody(o,{parse:n})}catch(o){return t(o)}}return t()};var H="application/json; charset=utf-8",X=new TextEncoder,U=class{},x=class extends Response{constructor(t,e={}){e.headers?e.headers instanceof Headers?e.headers.set("content-type",H):e.headers["content-type"]=H:e.headers={"content-type":H},super(JSON.stringify(t),e)}};function L(s,t,e){s.header=function(n,r){if(e.headers&&e.headers instanceof Headers&&(e.headers=Object.fromEntries(e.headers.entries())),e.headers=e.headers||{},typeof n=="string")return n=n.toLowerCase(),r?(e.headers[n]=r,this):e.headers[n];if(typeof n=="object"){n instanceof Headers&&(n=Object.fromEntries(n.entries()));for(let i in n)e.headers[i.toLowerCase()]=n[i];return this}return e.headers=new Headers(e.headers)},s.status=function(n){return n?(e.status=n,this):e.status||200},s.type=function(n){return this.header("content-type",n),this},s.send=function(n){return typeof n=="string"?t(new Response(X.encode(n),e)):typeof n=="object"?n instanceof Response?t(n):n instanceof Uint8Array||n instanceof ReadableStream||n instanceof FormData||n instanceof Blob||typeof n.read=="function"?t(new Response(n,e)):t(new x(n,e)):t(new Response(n,e))},s.json=function(n){return t(new x(n,e))},s.redirect=function(n,r){return this.header("Location",n).status(r||302).send()},s.cookie=function(n,r,i={}){return i.httpOnly=i.httpOnly!==!1,i.path=i.path||"/",i.maxAge&&(i.expires=new Date(Date.now()+i.maxAge),i.maxAge/=1e3),r=typeof r=="object"?"j:"+JSON.stringify(r):String(r),this.header().append("Set-Cookie",E(n,r,i)),this},s.clearCookie=function(n,r={}){r.httpOnly=r.httpOnly!==!1,this.header().append("Set-Cookie",E(n,"",{...r,expires:new Date(0)}))}}var A=(s,t,e)=>{let n=T(s,e==="development");return t.response.status(n.status).json(n)},v=class extends g{constructor({parseQuery:t,bodyLimit:e,env:n}={}){super();this.parseQuery=t||y,this.multipartParseQuery=t,this.bodyLimit=e,this.env=n||"development",t&&this.use((r,i)=>(r.__parseQuery=t,i()))}onError(t){return this._onError=(e,n,r)=>{n.__onErr=!0;let i=e.status||e.statusCode||e.code||500;return typeof i!="number"&&(i=500),n.response.status(i),t(e,n,r)},this}on404(t){return this._on404=(e,n)=>(e.response.status(404),t(e,n)),this}use(t,...e){let n=e,r="";if(typeof t=="function"&&n.length===0)return this.midds=this.midds.concat(t),this;typeof t=="string"?r=t==="/"?"":t:n=[t].concat(n);let i=n[n.length-1];return typeof i=="object"&&(i.c_routes||i[0].c_routes)?this.pushRoutes(r,b(n),i):r!==""?(this.pmidds=this.pmidds||{},this.pmidds[r]=D(r).concat(b(n))):this.midds=this.midds.concat(b(n)),this}on(t,e,...n){let r=b(n),{path:i,pathx:o,wild:a}=F(e,t==="ANY");return o?(this.route[t]=this.route[t]||[],this.route[t].push({path:i,pathx:o,fns:r,wild:a})):this.route[t+e]={fns:r},this}handle(t,e){let n=0,r=-1,i=0,o=0,a,{method:u,url:c}=t.request;for(t.search=null,t.query={};(r=c.indexOf("/",r+1))!=-1;)if(i+=1,i===3){for(t.url=t.path=c.substring(r),a=t.url.length;o<a;){if(t.url.charCodeAt(o)===63){t.path=t.url.substring(0,o),t.query=this.parseQuery(t.url.substring(o+1)),t.search=t.url.substring(o);break}o++}break}let{fns:h,params:d}=this.find(u,t.path,this._on404),l=p=>{let f;try{f=p?this._onError(p,t,l):h[n++](t,l)}catch(q){return p?A(q,t,this.env):l(q)}if(f)return typeof f.then=="function"?this.withPromise(f,t,l,t.__onErr):t.response.send(f)};return t.params=d,t.getCookies=p=>M(t.request,p),e&&(t.respondWith=p=>p),L(t.response={},t.respondWith,t.responseInit={}),u==="GET"||u==="HEAD"?l():B(t,l,this.parseQuery,this.multipartParseQuery,this.bodyLimit)}handleEvent(t){return this.handle(t,!0)}async listen(t,e){let n=!1;typeof t=="number"?t={port:t}:typeof t=="object"&&(n=t.certFile!==void 0);try{for(this.server=n?Deno.listenTls(t):Deno.listen(t),e&&e(void 0,{...t,hostname:t.hostname||"localhost",server:this.server});;)try{let r=await this.server.accept();if(r)this.handleConn(r);else break}catch(r){}}catch(r){e&&e(r,{...t,hostname:t.hostname||"localhost"})}}pushRoutes(t,e,n){n=Array.isArray(n)?n:[n],n.forEach(r=>{r.c_routes.forEach(i=>{let{method:o,path:a,fns:u}=i,c;if(a instanceof RegExp)c=P(t,a);else{let h=a;h==="/"&&t!==""&&(h=""),c=t+h}this.on(o,c,[e,u])})})}_onError(t,e,n){return A(t,e,this.env)}_on404(t,e){let n=T(new m(404,`Route ${t.request.method}${t.url} not found`,"NotFoundError"));return t.response.status(n.status).json(n)}async handleConn(t){try{let e=Deno.serveHttp(t);for await(let n of e){let r,i=new Promise(a=>r=a),o=n.respondWith(i);n.conn=t,n.respondWith=r,this.handle(n),await o}}catch(e){}}async withPromise(t,e,n,r){try{let i=await t;return i?e.response.send(i):void 0}catch(i){return r?A(i,e,this.env):n(i)}}};var W=class{};export{m as HttpError,U as HttpResponse,x as JsonResponse,v as NHttp,W as RequestEvent,g as Router,G as expressMiddleware,T as getError,$ as multipart};
